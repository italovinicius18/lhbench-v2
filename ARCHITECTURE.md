# Lakehouse Benchmark - Architecture

## 🏗️ System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Docker Compose Network                    │
│                                                              │
│  ┌─────────────────┐     ┌──────────────────────────────┐  │
│  │  TPC-H Gen      │     │      Spark Cluster           │  │
│  │  (tpchgen-cli)  │     │                              │  │
│  │                 │     │  ┌────────────────────────┐  │  │
│  │  - Rust-based   │────▶│  │   Spark Master        │  │  │
│  │  - 10x faster   │     │  │   :8080               │  │  │
│  │  - Parquet out  │     │  └────────────────────────┘  │  │
│  └─────────────────┘     │           │                  │  │
│                          │           ├──────────────────┤  │
│  ┌─────────────────┐     │           │                  │  │
│  │  Orchestrator   │     │  ┌────────▼──────────────┐  │  │
│  │  (Python)       │────▶│  │   Worker 1  :8081     │  │  │
│  │                 │     │  └───────────────────────┘  │  │
│  │  - run_benchmark│     │                              │  │
│  │  - Phase manager│     │  ┌───────────────────────┐  │  │
│  │  - State mgmt   │────▶│  │   Worker 2  :8082     │  │  │
│  └─────────────────┘     │  └───────────────────────┘  │  │
│                          └──────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────┐
                    │   Local Storage (WSL)     │
                    │   /mnt/c/.../lakehouse-   │
                    │                           │
                    │   Bronze/  Silver/  Gold/ │
                    └───────────────────────────┘
```

## 📊 Data Flow (Medallion Architecture)

```
Bronze Layer (Parquet)
────────────────────────
Generated by tpchgen-cli
Format: Parquet + Snappy
Size: 1GB - 1TB
Tables: customer, orders, lineitem, etc.
        │
        │ Conversion Jobs (PySpark)
        ▼
Silver Layer (Lakehouse Formats)
────────────────────────────────
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   Iceberg   │  │ Delta Lake  │  │    Hudi     │
│             │  │             │  │             │
│ - Snapshots │  │ - Time      │  │ - Copy on   │
│ - Schema    │  │   Travel    │  │   Write     │
│   Evolution │  │ - ACID      │  │ - Upserts   │
└─────────────┘  └─────────────┘  └─────────────┘
        │               │               │
        └───────────────┼───────────────┘
                        │ TPC-H Queries
                        ▼
Gold Layer (Metrics & Reports)
────────────────────────────────
- Query performance metrics (JSON)
- Comparative analysis
- Storage efficiency stats
- HTML/Markdown reports
```

## 🔄 Execution Flow

```
1. Setup Phase
   │
   ├─▶ Load .env configuration
   ├─▶ Initialize StateManager
   ├─▶ Setup logging & metrics
   └─▶ Create data directories
       │
       ▼
2. Bronze Phase (Data Generation)
   │
   ├─▶ Check if data exists (idempotent)
   ├─▶ Run tpchgen-cli
   │   └─▶ Generate Parquet files
   ├─▶ Save metadata
   └─▶ Mark phase complete
       │
       ▼
3. Silver Phase (Framework Conversion)
   │
   ├─▶ For each framework (parallel):
   │   │
   │   ├─▶ Iceberg: Parquet → Iceberg tables
   │   ├─▶ Delta: Parquet → Delta tables
   │   └─▶ Hudi: Parquet → Hudi tables
   │
   └─▶ Collect conversion metrics
       │
       ▼
4. Gold Phase (Query Benchmark)
   │
   ├─▶ For each framework (parallel):
   │   │
   │   ├─▶ Load TPC-H queries
   │   ├─▶ Execute with timing
   │   └─▶ Collect metrics
   │
   └─▶ Aggregate results
       │
       ▼
5. Report Phase (Analysis)
   │
   ├─▶ Aggregate metrics
   ├─▶ Generate comparisons
   ├─▶ Create visualizations
   └─▶ Export reports
```

## 🧩 Component Diagram

```
┌────────────────────────────────────────────────────────┐
│                    scripts/                             │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  run_benchmark.py (Main Orchestrator)            │  │
│  │                                                   │  │
│  │  - Loads configuration                           │  │
│  │  - Manages execution flow                        │  │
│  │  - Handles errors & retries                      │  │
│  └──────────────────────────────────────────────────┘  │
│                        │                                │
│                        ├──────────────────┬─────────────┤
│                        ▼                  ▼             ▼
│  ┌─────────────┐  ┌──────────┐  ┌────────────────┐    │
│  │   phases/   │  │ utils/   │  │ orchestrator/  │    │
│  │             │  │          │  │                │    │
│  │ - bronze    │  │ - config │  │ - state mgr   │    │
│  │ - silver    │  │ - logger │  │ - task runner │    │
│  │ - gold      │  │ - metrics│  │                │    │
│  │ - report    │  │          │  │                │    │
│  └─────────────┘  └──────────┘  └────────────────┘    │
└────────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────────┐
│                  spark_jobs/                            │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  common/ (Shared Utilities)                      │  │
│  │  - SparkSessionBuilder (framework-aware)         │  │
│  │  - CacheManager                                  │  │
│  └──────────────────────────────────────────────────┘  │
│                        │                                │
│        ┌───────────────┼───────────────┐               │
│        ▼               ▼               ▼               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │ silver/  │  │  gold/   │  │ bronze/  │             │
│  │          │  │          │  │          │             │
│  │ iceberg/ │  │ queries/ │  │ (uses    │             │
│  │ delta/   │  │ metrics/ │  │ tpchgen) │             │
│  │ hudi/    │  │          │  │          │             │
│  └──────────┘  └──────────┘  └──────────┘             │
└────────────────────────────────────────────────────────┘
```

## 🔐 State Management

```
State File: /data/bronze/tpch/_metadata/state.json

{
  "phases": {
    "bronze": {
      "status": "completed",
      "completed_at": "2025-10-01T10:00:00Z",
      "result": {...}
    },
    "silver_iceberg": {
      "status": "running",
      "started_at": "2025-10-01T10:05:00Z"
    },
    ...
  },
  "benchmarks": [
    {
      "benchmark_id": "benchmark_20251001_100000",
      "timestamp": "...",
      "status": "success",
      ...
    }
  ]
}
```

**Benefits**:
- ✅ Idempotency: Skip completed phases
- ✅ Recovery: Resume after failures
- ✅ History: Track all benchmark runs
- ✅ Debugging: Understand execution state

## 📈 Metrics Collection

```
Metrics Flow:

┌──────────────┐
│ Phase Starts │
└──────┬───────┘
       │
       ▼
┌───────────────────┐
│ MetricsCollector  │
│ .start_operation()│
└──────┬────────────┘
       │
       │ ┌─────────────────────┐
       ├─▶ Record start time   │
       │ └─────────────────────┘
       │
       │ [Operation Executes]
       │
       ▼
┌───────────────────────┐
│ MetricsCollector      │
│ .complete_operation() │
└──────┬────────────────┘
       │
       ├─▶ Record end time
       ├─▶ Calculate duration
       ├─▶ Add metadata
       └─▶ Save to JSON
           │
           ▼
    ┌──────────────────────┐
    │ results/metrics/     │
    │ - bronze_sf10.json   │
    │ - silver_iceberg.json│
    │ - gold_iceberg.json  │
    └──────────────────────┘
```

## 🎯 Configuration Hierarchy

```
.env.example
    │
    ├─▶ TPCH_SCALE_FACTOR ────▶ Bronze Phase
    │                             │
    ├─▶ FRAMEWORKS ───────────────┼─▶ Silver Phase
    │                             │
    ├─▶ SPARK_* ──────────────────┼─▶ All Spark Jobs
    │                             │
    ├─▶ ICEBERG_* ────────────────┼─▶ Iceberg Jobs
    ├─▶ DELTA_* ──────────────────┼─▶ Delta Jobs
    └─▶ HUDI_* ───────────────────┼─▶ Hudi Jobs
                                  │
                                  ▼
                           SparkSessionBuilder
                           (framework-aware)
```

## 🐳 Docker Architecture

```
docker-compose.yml
    │
    ├─▶ spark-master (always)
    │   - Spark 3.5
    │   - Iceberg/Delta/Hudi JARs
    │   - Port 8080, 7077
    │
    ├─▶ spark-worker-1 (always)
    │   - Connects to master
    │   - Configurable cores/memory
    │   - Port 8081
    │
    ├─▶ spark-worker-2 (always)
    │   - Port 8082
    │
    ├─▶ tpchgen (profile: datagen)
    │   - Rust-based generator
    │   - Runs on demand
    │
    └─▶ benchmark-orchestrator (profile: benchmark)
        - Python orchestration
        - Runs phases
        - Manages state
```

## 📂 Storage Layout

```
/mnt/c/Users/italo/WSL_DATA/lakehouse-data/

bronze/
  └── tpch/
      ├── _metadata/
      │   ├── state.json
      │   ├── generation_index.json
      │   ├── sf1_info.json
      │   └── sf10_info.json
      ├── sf1/
      │   ├── customer.parquet
      │   ├── orders.parquet
      │   └── ...
      └── sf10/
          └── ...

silver/
  ├── iceberg/
  │   └── tpch/
  │       ├── customer/
  │       ├── orders/
  │       └── ...
  ├── delta/
  │   └── tpch/
  │       └── ...
  └── hudi/
      └── tpch/
          └── ...

gold/
  ├── metrics/
  │   ├── benchmark_20251001_100000.json
  │   └── ...
  └── reports/
      ├── comparison_report.html
      └── ...
```

## 🚀 Performance Optimizations

1. **Data Generation**
   - tpchgen-cli (Rust): 10x faster than DuckDB
   - Parallel generation via `--parts`
   - Snappy compression

2. **State Management**
   - Idempotent phases (skip if complete)
   - Smart caching
   - Incremental execution

3. **Spark Configuration**
   - Adaptive Query Execution
   - Dynamic partition coalescing
   - Configurable parallelism

4. **Storage**
   - Local filesystem (no S3 overhead)
   - Columnar formats (Parquet)
   - Optimized row groups

---

**Architecture Status**: ✅ Complete foundation | 🏗️ Silver/Gold jobs pending
